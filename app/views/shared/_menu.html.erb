<div class="d-flex justify-content-end">
  <%
      today = Date.today
      start_of_month = today.beginning_of_month

      schedules_without_register = Schedule
        .where(date: start_of_month..(today - 1), profile: current_user.profiles.pluck(:id))
        .where.not(
          date: Register.select(:date).where(profile: current_user.profiles.pluck(:id)))
        .order(:date)

      badge_count = schedules_without_register.count
      badge_visibility = badge_count.positive? ? "" : "d-none"
      notification_click = badge_count.positive? ? "#notificationDropdown" : ""
    %>
  <button class="btn text-cDarkGray fs-3 p-0 position-relative overflow-visible" style="width:50px;" type="button"
    data-bs-toggle="collapse"
    data-bs-target="<%= notification_click %>">
    <i class="fa-regular fa-bell"></i>
    <span id="notificationBadge" class="position-absolute translate-middle badge rounded-pill bg-danger <%= badge_visibility %>" style="font-size:0.6rem;top:15px; right:-5px;">
      <%= badge_count %>
      <span class="visually-hidden">unread messages</span>
    </span>
    <div class="collapse" id="notificationDropdown" style="position:absolute; right:0; z-index:1050; width:200px;">
      <div class="card card-body" style="background-color:white;font-size:0.9rem;max-height:300px; overflow-y:auto;">
        <% schedules_without_register.each do |schedule| %>
          <div class="notification-item"
            data-controller="notification"
            data-action="click->notification#select"
            data-notification-date="<%= schedule.date %>"
            data-notification-gemba-id="<%= schedule.gemba_id %>">
            <%= schedule.date.strftime("%d/%m/%Y") + " - " + schedule.gemba.name + " (" + schedule.period.description + ")" %>
          </div>
          <hr>
        <% end %>
      </div>
    </div>
  </button>
  <button class="btn text-cYellow fs-3 p-0" style="width:50px;" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasMenu" aria-controls="offcanvasMenu">
    <i class="fa-solid fa-bars"></i>
  </button>
</div>
<div class="offcanvas text-cWhite offcanvas-start" style="background-color:#212529;" data-bs-theme="dark" tabindex="-1" id="offcanvasMenu" aria-labelledby="offcanvasMenuLabel">
  <div class="offcanvas-header">
    <button type="button" class="btn-close"  data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <ul class="list-group list-group-flush">
      <li class="list-group-item border-0">
        <%= link_to main_path, class: "text-decoration-none text-cWhite" do %>
          <i class="fa-solid fa-house"></i> <span>Home</span>
        <% end %>
      </li>
      <% if current_user.profiles&.first&.role&.id == 1  %>
        <li class="list-group-item border-0">
          <%= link_to data_import_path, class: "text-decoration-none text-cWhite" do %>
            <i class="fa-solid fa-upload"></i> <span>Importar</span>
          <% end %>
        </li>
      <% end %>
      <li class="list-group-item border-0">
        <%= link_to data_export_path, class: "text-decoration-none text-cWhite" do %>
          <i class="fa-solid fa-file-export"></i> <span>Exportar</span>
        <% end %>
      </li>
      <% unless current_user.profiles&.first&.role&.id == 2   %>
        <li class="list-group-item border-0">
          <%= link_to profiles_path, class: "text-decoration-none text-cWhite" do %>
            <i class="fa-solid fa-user"></i> <span>Funcion√°rios</span>
          <% end %>
        <% end %>
      </li>
      <% unless current_user.profiles&.first&.role&.id == 2   %>
        <li class="list-group-item border-0">
          <%= link_to new_gemba_path, class: "text-decoration-none text-cWhite" do %>
            <i class="fa-solid fa-person-digging"></i> <span>Gemba</span>
          <% end %>
        </li>
      <% end %>
      <% if current_user.profiles&.first&.role&.id == 1  %>
        <li class="list-group-item border-0">
          <%= link_to new_company_path, class: "text-decoration-none text-cWhite" do %>
            <i class="fa-solid fa-building"></i> <span>Empresa</span>
          <% end %>
        </li>
      <% end %>
      <% unless current_user.profiles&.first&.role&.id == 2   %>
        <li class="list-group-item border-0">
          <%= link_to schedules_path, class: "text-decoration-none text-cWhite" do %>
            <i class="fa-solid fa-calendar"></i> <span>Agenda</span>
          <% end %>
        </li>
      <% end %>
      <li class="list-group-item border-0">
        <%= link_to destroy_user_session_path,  data: { turbo_method: :delete }, class: "text-decoration-none text-cWhite" do %>
          <i class="fa-solid fa-arrow-right-from-bracket"></i> <span>Sair</span>
        <% end %>
      </li>
    </ul>
  </div>
</div>
